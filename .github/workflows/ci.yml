name: Backend CI
on:
  push:
    branches:
      - "main"
      - "master"
      - "develop"
      - "release/**"
      - "hotfix/**"
    paths:
      - "app/**"
      - "tests/**"
      - ".pre-commit-config.yaml"
      - "pyproject.toml"
      - "uv.lock"
      - "Dockerfile"
      - "docker-compose.test.yml"
      - "docker-compose.yml"
  pull_request:
    branches:
      - "main"
      - "master"
      - "develop"
    paths:
      - "app/**"
      - "tests/**"
      - ".pre-commit-config.yaml"
      - "pyproject.toml"
      - "uv.lock"
      - "Dockerfile"
      - "docker-compose.test.yml"
      - "docker-compose.yml"
jobs:
  quality-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
          enable-cache: true
      - name: Set up Python
        run: uv python install 3.13
      - name: Install dependencies
        run: uv sync
      - name: Load cached pre-commit env
        uses: actions/cache@v3
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
      - name: Run pre-commit
        run: uv run pre-commit run --all-files --show-diff-on-failure
      - name: Build Docker images
        run: docker compose -f docker-compose.test.yml build
      - name: Run Tests via Docker Compose
        run: docker compose -f docker-compose.test.yml run --rm test
